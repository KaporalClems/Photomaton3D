<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photomaton Studio Pro - √âditeur 3D</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        .preview-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            touch-action: none;
        }
        #videoFeed {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .mirror { transform: scaleX(-1); }

        /* Style commun pour les √©l√©ments d√©pla√ßables */
        .draggable-element {
            position: absolute;
            cursor: move;
            user-select: none;
            z-index: 10;
            border: 2px dashed transparent;
            touch-action: none;
        }
        .draggable-element.active {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        
        #templateWrapper { top: 10%; left: 10%; width: 150px; }
        #text3DWrapper { top: 40%; left: 30%; width: 250px; height: 100px; }

        .resize-handle {
            position: absolute;
            width: 24px;
            height: 24px;
            background: #3b82f6;
            border: 3px solid white;
            border-radius: 50%;
            bottom: -12px;
            right: -12px;
            cursor: nwse-resize;
            display: none;
            z-index: 20;
        }
        .active .resize-handle { display: block; }

        #threeCanvasContainer {
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .flash {
            position: absolute; inset: 0; background: white; opacity: 0; pointer-events: none; z-index: 100;
        }
        @keyframes flash-anim { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }
        .animate-flash { animation: flash-anim 0.4s ease-out; }
        
        #errorOverlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.8);
            display: none; flex-direction: column; align-items: center;
            justify-content: center; z-index: 50;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen flex flex-col items-center p-2 sm:p-4 font-sans">

    <header class="text-center mb-4">
        <h1 class="text-3xl font-black tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-yellow-400 via-orange-500 to-red-600">
            STUDIO 3D PRO
        </h1>
    </header>

    <main class="w-full max-w-6xl grid grid-cols-1 xl:grid-cols-4 gap-4">
        
        <div class="xl:col-span-3 flex flex-col items-center">
            <div class="preview-container border border-slate-800" id="editorZone">
                <video id="videoFeed" autoplay playsinline muted class="mirror"></video>

                <!-- Element Image -->
                <div id="templateWrapper" class="draggable-element hidden" data-type="img">
                    <img id="templateOverlay" src="" alt="" class="w-full h-auto pointer-events-none" crossorigin="anonymous">
                    <div class="resize-handle"></div>
                </div>

                <!-- Element Texte 3D -->
                <div id="text3DWrapper" class="draggable-element" data-type="text">
                    <div id="threeCanvasContainer"></div>
                    <div class="resize-handle"></div>
                </div>

                <div id="errorOverlay">
                    <p class="text-white mb-2">Erreur Cam√©ra</p>
                    <button onclick="initCam()" class="bg-slate-700 px-4 py-2 rounded-lg text-xs">R√©essayer</button>
                </div>

                <button id="btnSwitchCam" class="absolute top-4 right-4 z-20 bg-black/50 p-3 rounded-full border border-white/20">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                </button>

                <div id="flashOverlay" class="flash"></div>
                <div id="countdown" class="absolute inset-0 flex items-center justify-center text-8xl font-black text-white hidden z-[100]"></div>
            </div>

            <button id="btnCapture" class="mt-4 w-full sm:w-auto bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-12 py-4 rounded-2xl font-bold text-xl shadow-xl active:scale-95 transition-all">
                üì∏ PRENDRE LA PHOTO
            </button>
        </div>

        <div class="bg-slate-900 p-4 rounded-3xl border border-slate-800 space-y-6">
            <div>
                <h2 class="text-sm font-bold mb-3 text-green-400">Biblioth√®que</h2>
                <div id="libraryGrid" class="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto"></div>
            </div>

            <div>
                <h2 class="text-sm font-bold mb-3 text-blue-400">Texte 3D</h2>
                <div class="space-y-3">
                    <label class="flex items-center gap-2 text-xs bg-slate-800 p-2 rounded-lg">
                        <input type="checkbox" id="toggle3D" checked> Afficher
                    </label>
                    <textarea id="text3DInput" rows="1" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none" placeholder="Votre texte..."></textarea>
                </div>
            </div>

            <div class="pt-4 border-t border-slate-800" id="resultArea" class="hidden">
                <div id="gallery"></div>
            </div>
            
            <button id="btnClearCache" class="text-[10px] text-slate-500 uppercase">R√©initialiser</button>
        </div>
    </main>

    <canvas id="canvasProcess" class="hidden"></canvas>

    <script>
        const video = document.getElementById('videoFeed');
        const editorZone = document.getElementById('editorZone');
        const canvas = document.getElementById('canvasProcess');
        const ctx = canvas.getContext('2d');
        
        let scene, camera, renderer, textMesh;
        let currentFacingMode = 'user';
        let activeElement = null;
        let isDragging = false, isResizing = false;
        let startX, startY, startW, startH, startL, startT;

        const libraryImages = [
            'https://raw.githubusercontent.com/KaporalClems/Photomaton3D/5dc4e25d47a4d6d178158184765608690f4a7a81/output-onlinegiftools.gif',
            'https://raw.githubusercontent.com/KaporalClems/Photomaton3D/5dc4e25d47a4d6d178158184765608690f4a7a81/437-4377362_totoro-totoro-and-little-totoros-removebg-preview.png'
        ];

        // --- GESTION DRAG & RESIZE UNIFI√âE ---
        function makeManipulable(el) {
            const onStart = (e) => {
                const pointer = e.touches ? e.touches[0] : e;
                activeElement = el;
                
                // D√©sactiver les autres
                document.querySelectorAll('.draggable-element').forEach(d => d.classList.remove('active'));
                el.classList.add('active');

                if (e.target.classList.contains('resize-handle')) {
                    isResizing = true;
                } else {
                    isDragging = true;
                }

                startX = pointer.clientX;
                startY = pointer.clientY;
                startW = el.offsetWidth;
                startH = el.offsetHeight;
                startL = el.offsetLeft;
                startT = el.offsetTop;

                e.preventDefault();
            };

            el.addEventListener('mousedown', onStart);
            el.addEventListener('touchstart', onStart, {passive: false});
        }

        window.addEventListener('mousemove', (e) => {
            if (!activeElement || (!isDragging && !isResizing)) return;
            const pointer = e.touches ? e.touches[0] : e;
            const dx = pointer.clientX - startX;
            const dy = pointer.clientY - startY;

            if (isDragging) {
                activeElement.style.left = (startL + dx) + 'px';
                activeElement.style.top = (startT + dy) + 'px';
            }
            if (isResizing) {
                const nw = Math.max(50, startW + dx);
                activeElement.style.width = nw + 'px';
                if (activeElement.id === 'text3DWrapper') {
                    activeElement.style.height = Math.max(30, startH + dy) + 'px';
                    onTextContainerResize();
                }
            }
        });

        window.addEventListener('mouseup', () => { isDragging = isResizing = false; saveSettings(); });
        window.addEventListener('touchend', () => { isDragging = isResizing = false; saveSettings(); });

        // --- THREE.JS ---
        function init3D() {
            const container = document.getElementById('threeCanvasContainer');
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true, preserveDrawingBuffer: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);
            scene.add(new THREE.AmbientLight(0xffffff, 1));
            camera.position.z = 3;
            updateText3D();
            
            const animate = () => {
                requestAnimationFrame(animate);
                if(textMesh) textMesh.rotation.y = Math.sin(Date.now()*0.001)*0.2;
                renderer.render(scene, camera);
            };
            animate();
        }

        function onTextContainerResize() {
            const container = document.getElementById('threeCanvasContainer');
            if (renderer && camera) {
                renderer.setSize(container.clientWidth, container.clientHeight);
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
            }
        }

        function updateText3D() {
            const text = document.getElementById('text3DInput').value || "HELLO";
            const visible = document.getElementById('toggle3D').checked;
            document.getElementById('text3DWrapper').style.display = visible ? 'block' : 'none';
            if(!visible) return;

            new THREE.FontLoader().load('https://threejs.org/examples/fonts/helvetiker_bold.typeface.json', (font) => {
                if (textMesh) scene.remove(textMesh);
                const geo = new THREE.TextGeometry(text, { font: font, size: 0.5, height: 0.1, bevelEnabled: true, bevelThickness: 0.02, bevelSize: 0.02 });
                geo.center();
                textMesh = new THREE.Mesh(geo, new THREE.MeshPhongMaterial({ color: 0xffcc00 }));
                scene.add(textMesh);
            });
        }

        // --- CAMERA & CAPTURE ---
        async function initCam() {
            if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
            video.classList.toggle('mirror', currentFacingMode === 'user');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacingMode, width: 1280, height: 720 } });
                video.srcObject = stream;
            } catch (e) { document.getElementById('errorOverlay').style.display = 'flex'; }
        }

        function doCapture() {
            const vW = video.videoWidth, vH = video.videoHeight;
            if (vW === 0) return;
            canvas.width = vW; canvas.height = vH;
            
            // 1. Vid√©o
            ctx.save();
            if(currentFacingMode === 'user') { ctx.translate(vW, 0); ctx.scale(-1, 1); }
            ctx.drawImage(video, 0, 0, vW, vH);
            ctx.restore();

            const rect = editorZone.getBoundingClientRect();
            const sx = vW / rect.width;
            const sy = vH / rect.height;

            // 2. Texte 3D
            if (document.getElementById('toggle3D').checked) {
                const w = document.getElementById('text3DWrapper').getBoundingClientRect();
                ctx.drawImage(renderer.domElement, (w.left - rect.left) * sx, (w.top - rect.top) * sy, w.width * sx, w.height * sy);
            }

            // 3. Image Overlay
            const imgWrap = document.getElementById('templateWrapper');
            if (!imgWrap.classList.contains('hidden')) {
                const w = imgWrap.getBoundingClientRect();
                ctx.drawImage(document.getElementById('templateOverlay'), (w.left - rect.left) * sx, (w.top - rect.top) * sy, w.width * sx, w.height * sy);
            }

            const url = canvas.toDataURL('image/png');
            document.getElementById('resultArea').classList.remove('hidden');
            document.getElementById('gallery').innerHTML = `<img src="${url}" class="rounded-lg mb-2"><a href="${url}" download="photo.png" class="block bg-blue-600 text-center py-2 rounded font-bold">TELECHARGER</a>`;
        }

        // --- INIT ---
        function loadTemplate(src) {
            const img = document.getElementById('templateOverlay');
            img.src = src;
            img.onload = () => {
                document.getElementById('templateWrapper').classList.remove('hidden');
                document.getElementById('templateWrapper').classList.add('active');
                activeElement = document.getElementById('templateWrapper');
            };
        }

        function initLibrary() {
            const grid = document.getElementById('libraryGrid');
            libraryImages.forEach(src => {
                const img = document.createElement('img');
                img.src = src;
                img.className = 'w-full h-16 object-contain bg-slate-800 rounded cursor-pointer border-2 border-transparent hover:border-green-500';
                img.onclick = () => loadTemplate(src);
                grid.appendChild(img);
            });
        }

        function saveSettings() {
            const data = {
                text: document.getElementById('text3DInput').value,
                textPos: { t: text3DWrapper.style.top, l: text3DWrapper.style.left, w: text3DWrapper.style.width, h: text3DWrapper.style.height }
            };
            localStorage.setItem('studio_3d_v3', JSON.stringify(data));
        }

        document.getElementById('btnCapture').onclick = () => {
            const count = document.getElementById('countdown');
            let c = 3; count.classList.remove('hidden'); count.textContent = c;
            const itv = setInterval(() => {
                c--;
                if(c<=0) { clearInterval(itv); count.classList.add('hidden'); doCapture(); }
                else count.textContent = c;
            }, 800);
        };

        document.getElementById('text3DInput').oninput = updateText3D;
        document.getElementById('toggle3D').onchange = updateText3D;
        document.getElementById('btnSwitchCam').onclick = () => { currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user'; initCam(); };
        
        window.onload = () => {
            initLibrary();
            initCam();
            init3D();
            makeManipulable(document.getElementById('templateWrapper'));
            makeManipulable(document.getElementById('text3DWrapper'));
        };
    </script>
</body>
</html>
