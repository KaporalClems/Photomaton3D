<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Photomaton Studio Pro - Éditeur 3D</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { touch-action: none; overflow: hidden; }
        .preview-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        #videoFeed { width: 100%; height: 100%; object-fit: cover; }
        .mirror { transform: scaleX(-1); }

        .draggable-element {
            position: absolute;
            cursor: move;
            user-select: none;
            z-index: 10;
            border: 2px dashed transparent;
            touch-action: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .draggable-element.active {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            z-index: 30;
        }
        
        #templateWrapper { top: 10%; left: 10%; width: 120px; }
        #text3DWrapper { top: 40%; left: 30%; width: 200px; height: 80px; }

        /* Poignées et Contrôles */
        .resize-handle {
            position: absolute;
            width: 32px;
            height: 32px;
            background: #3b82f6;
            border: 3px solid white;
            border-radius: 50%;
            bottom: -16px;
            right: -16px;
            cursor: nwse-resize;
            display: none;
            z-index: 40;
        }
        .delete-btn {
            position: absolute;
            width: 32px;
            height: 32px;
            background: #ef4444;
            border: 3px solid white;
            border-radius: 50%;
            top: -16px;
            left: -16px;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
            z-index: 40;
        }
        .active .resize-handle, .active .delete-btn { display: flex; }

        #threeCanvasContainer { width: 100%; height: 100%; pointer-events: none; }
        .flash { position: absolute; inset: 0; background: white; opacity: 0; pointer-events: none; z-index: 100; }
        @keyframes flash-anim { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }
        .animate-flash { animation: flash-anim 0.4s ease-out; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen flex flex-col items-center p-2 font-sans">

    <header class="text-center mb-2">
        <h1 class="text-2xl font-black tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-yellow-400 to-red-600 uppercase">
            Studio Mobile 3D
        </h1>
    </header>

    <main class="w-full max-w-6xl grid grid-cols-1 xl:grid-cols-4 gap-4 overflow-y-auto pb-20">
        
        <div class="xl:col-span-3 flex flex-col items-center">
            <div class="preview-container border border-slate-800" id="editorZone">
                <video id="videoFeed" autoplay playsinline muted class="mirror"></video>

                <!-- Element Image -->
                <div id="templateWrapper" class="draggable-element hidden">
                    <div class="delete-btn" onclick="removeElement('templateWrapper')">✕</div>
                    <img id="templateOverlay" src="" alt="" class="w-full h-auto pointer-events-none" crossorigin="anonymous">
                    <div class="resize-handle"></div>
                </div>

                <!-- Element Texte 3D -->
                <div id="text3DWrapper" class="draggable-element">
                    <div class="delete-btn" onclick="removeElement('text3DWrapper')">✕</div>
                    <div id="threeCanvasContainer"></div>
                    <div class="resize-handle"></div>
                </div>

                <button id="btnSwitchCam" class="absolute top-2 right-2 z-20 bg-black/50 p-3 rounded-full border border-white/20">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                </button>

                <div id="flashOverlay" class="flash"></div>
                <div id="countdown" class="absolute inset-0 flex items-center justify-center text-7xl font-black text-white hidden z-[100]"></div>
            </div>

            <button id="btnCapture" class="mt-4 w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg active:scale-95 transition-all">
                PRENDRE LA PHOTO
            </button>
        </div>

        <div class="bg-slate-900 p-4 rounded-2xl border border-slate-800 space-y-4">
            <div>
                <h2 class="text-xs font-bold mb-2 text-green-400 uppercase">Bibliothèque</h2>
                <div id="libraryGrid" class="grid grid-cols-3 gap-2 max-h-32 overflow-y-auto"></div>
            </div>

            <div>
                <h2 class="text-xs font-bold mb-2 text-blue-400 uppercase">Texte 3D</h2>
                <input type="text" id="text3DInput" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none mb-2" placeholder="Texte...">
                <button onclick="addElement('text3DWrapper')" class="w-full bg-slate-800 text-xs py-2 rounded border border-slate-700">RÉAPPARAÎTRE TEXTE</button>
            </div>

            <div id="resultArea" class="hidden pt-4 border-t border-slate-800">
                <div id="gallery"></div>
            </div>
        </div>
    </main>

    <canvas id="canvasProcess" class="hidden"></canvas>

    <script>
        const video = document.getElementById('videoFeed');
        const editorZone = document.getElementById('editorZone');
        const canvas = document.getElementById('canvasProcess');
        const ctx = canvas.getContext('2d');
        
        let scene, camera, renderer, textMesh;
        let currentFacingMode = 'user';
        let activeElement = null;
        let isDragging = false, isResizing = false;
        let startX, startY, startW, startH, startL, startT;

        const libraryImages = [
            'https://raw.githubusercontent.com/KaporalClems/Photomaton3D/5dc4e25d47a4d6d178158184765608690f4a7a81/output-onlinegiftools.gif',
            'https://raw.githubusercontent.com/KaporalClems/Photomaton3D/5dc4e25d47a4d6d178158184765608690f4a7a81/437-4377362_totoro-totoro-and-little-totoros-removebg-preview.png'
        ];

        // --- GESTION ÉLÉMENTS ---
        function removeElement(id) {
            document.getElementById(id).classList.add('hidden');
        }

        function addElement(id) {
            const el = document.getElementById(id);
            el.classList.remove('hidden');
            el.style.top = "20%"; el.style.left = "20%";
            selectElement(el);
        }

        function selectElement(el) {
            document.querySelectorAll('.draggable-element').forEach(d => d.classList.remove('active'));
            el.classList.add('active');
            activeElement = el;
        }

        // --- TOUCH & MOUSE UNIFIÉ ---
        function makeManipulable(el) {
            const onStart = (e) => {
                const pointer = e.touches ? e.touches[0] : e;
                if(e.target.classList.contains('delete-btn')) return;
                
                selectElement(el);

                if (e.target.classList.contains('resize-handle')) {
                    isResizing = true;
                } else {
                    isDragging = true;
                }

                startX = pointer.clientX; startY = pointer.clientY;
                startW = el.offsetWidth; startH = el.offsetHeight;
                startL = el.offsetLeft; startT = el.offsetTop;
                if(e.cancelable) e.preventDefault();
            };

            el.addEventListener('mousedown', onStart);
            el.addEventListener('touchstart', onStart, {passive: false});
        }

        const onMove = (e) => {
            if (!activeElement || (!isDragging && !isResizing)) return;
            const pointer = e.touches ? e.touches[0] : e;
            const dx = pointer.clientX - startX;
            const dy = pointer.clientY - startY;

            if (isDragging) {
                activeElement.style.left = (startL + dx) + 'px';
                activeElement.style.top = (startT + dy) + 'px';
            }
            if (isResizing) {
                activeElement.style.width = Math.max(60, startW + dx) + 'px';
                if (activeElement.id === 'text3DWrapper') {
                    activeElement.style.height = Math.max(40, startH + dy) + 'px';
                    onTextContainerResize();
                }
            }
        };

        window.addEventListener('mousemove', onMove);
        window.addEventListener('touchmove', onMove, {passive: false});
        window.addEventListener('mouseup', () => isDragging = isResizing = false);
        window.addEventListener('touchend', () => isDragging = isResizing = false);

        // --- THREE.JS ---
        function init3D() {
            const container = document.getElementById('threeCanvasContainer');
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true, preserveDrawingBuffer: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);
            scene.add(new THREE.AmbientLight(0xffffff, 1.2));
            camera.position.z = 3;
            updateText3D();
            
            const animate = () => {
                requestAnimationFrame(animate);
                if(textMesh) textMesh.rotation.y += 0.01;
                renderer.render(scene, camera);
            };
            animate();
        }

        function onTextContainerResize() {
            const container = document.getElementById('threeCanvasContainer');
            if (renderer && camera) {
                renderer.setSize(container.clientWidth, container.clientHeight);
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
            }
        }

        function updateText3D() {
            const text = document.getElementById('text3DInput').value || "HELLO";
            new THREE.FontLoader().load('https://threejs.org/examples/fonts/helvetiker_bold.typeface.json', (font) => {
                if (textMesh) scene.remove(textMesh);
                const geo = new THREE.TextGeometry(text, { font: font, size: 0.5, height: 0.1, bevelEnabled: true, bevelThickness: 0.02, bevelSize: 0.02 });
                geo.center();
                textMesh = new THREE.Mesh(geo, new THREE.MeshPhongMaterial({ color: 0xffcc00 }));
                scene.add(textMesh);
            });
        }

        // --- CAMERA & CAPTURE ---
        async function initCam() {
            if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
            video.classList.toggle('mirror', currentFacingMode === 'user');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacingMode, width: 1280, height: 720 } });
                video.srcObject = stream;
            } catch (e) { alert("Caméra indisponible"); }
        }

        function doCapture() {
            const vW = video.videoWidth, vH = video.videoHeight;
            if (vW === 0) return;
            canvas.width = vW; canvas.height = vH;
            
            ctx.save();
            if(currentFacingMode === 'user') { ctx.translate(vW, 0); ctx.scale(-1, 1); }
            ctx.drawImage(video, 0, 0, vW, vH);
            ctx.restore();

            const rect = editorZone.getBoundingClientRect();
            const sx = vW / rect.width;
            const sy = vH / rect.height;

            // Texte 3D
            const txtWrap = document.getElementById('text3DWrapper');
            if (!txtWrap.classList.contains('hidden')) {
                const w = txtWrap.getBoundingClientRect();
                ctx.drawImage(renderer.domElement, (w.left - rect.left) * sx, (w.top - rect.top) * sy, w.width * sx, w.height * sy);
            }

            // Image Overlay
            const imgWrap = document.getElementById('templateWrapper');
            if (!imgWrap.classList.contains('hidden')) {
                const w = imgWrap.getBoundingClientRect();
                ctx.drawImage(document.getElementById('templateOverlay'), (w.left - rect.left) * sx, (w.top - rect.top) * sy, w.width * sx, w.height * sy);
            }

            const url = canvas.toDataURL('image/png');
            document.getElementById('resultArea').classList.remove('hidden');
            document.getElementById('gallery').innerHTML = `<img src="${url}" class="rounded-lg mb-2 shadow-xl"><a href="${url}" download="photo.png" class="block bg-green-600 text-center py-3 rounded-lg font-bold">ENREGISTRER</a>`;
            document.getElementById('resultArea').scrollIntoView();
        }

        // --- INIT ---
        function loadTemplate(src) {
            const wrap = document.getElementById('templateWrapper');
            const img = document.getElementById('templateOverlay');
            img.src = src;
            img.onload = () => {
                wrap.classList.remove('hidden');
                selectElement(wrap);
            };
        }

        function initLibrary() {
            const grid = document.getElementById('libraryGrid');
            libraryImages.forEach(src => {
                const img = document.createElement('img');
                img.src = src;
                img.className = 'w-full h-12 object-contain bg-slate-800 rounded p-1 border border-slate-700';
                img.onclick = () => loadTemplate(src);
                grid.appendChild(img);
            });
        }

        document.getElementById('btnCapture').onclick = () => {
            const count = document.getElementById('countdown');
            let c = 3; count.classList.remove('hidden'); count.textContent = c;
            const itv = setInterval(() => {
                c--;
                if(c<=0) { clearInterval(itv); count.classList.add('hidden'); doCapture(); }
                else count.textContent = c;
            }, 700);
        };

        document.getElementById('text3DInput').oninput = updateText3D;
        document.getElementById('btnSwitchCam').onclick = () => { currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user'; initCam(); };
        
        window.onload = () => {
            initLibrary(); initCam(); init3D();
            makeManipulable(document.getElementById('templateWrapper'));
            makeManipulable(document.getElementById('text3DWrapper'));
        };
    </script>
</body>
</html>
